# API 日志优化配置说明

## 概述

为了减少API端的日志噪音，特别是避免大量INFO级别的调试信息掩盖真正的错误，我们实现了灵活的日志配置系统。

## 主要改进

### 1. 环境变量控制
新增以下环境变量来控制日志行为：

```bash
# 全局日志级别
LOG_LEVEL=INFO                  # DEBUG, INFO, WARNING, ERROR

# 调试日志开关
ENABLE_DEBUG_LOGS=false         # 控制业务调试日志
ENABLE_RLS_DEBUG=false          # 专门控制RLS调试日志
ENABLE_HTTP_LOGS=false          # 控制HTTP请求日志
LOG_SQL_QUERIES=false           # 控制SQL查询日志
```

### 2. 生产环境推荐配置

```bash
# 生产环境：最小化日志输出
LOG_LEVEL=WARNING
ENABLE_DEBUG_LOGS=false
ENABLE_RLS_DEBUG=false  
ENABLE_HTTP_LOGS=false
LOG_SQL_QUERIES=false
```

这样配置只会记录WARNING和ERROR级别的日志，大大减少噪音。

### 3. 开发环境配置

```bash
# 开发环境：详细调试信息
LOG_LEVEL=DEBUG
ENABLE_DEBUG_LOGS=true
ENABLE_RLS_DEBUG=true
ENABLE_HTTP_LOGS=true
LOG_SQL_QUERIES=true
```

### 4. 问题排查配置

如果需要排查特定问题，可以单独开启相关日志：

```bash
# 只开启RLS调试（用户权限问题）
ENABLE_RLS_DEBUG=true

# 只开启HTTP日志（API调用问题）
ENABLE_HTTP_LOGS=true

# 只开启业务调试（积分、语音等服务问题）
ENABLE_DEBUG_LOGS=true
```

## 优化的服务

### 1. 用户服务 (UserService)
- 所有 `[RLS_DEBUG]` 日志改为条件记录
- 只在 `ENABLE_RLS_DEBUG=true` 时输出
- 错误日志使用结构化格式

### 2. 积分服务 (PointsService)
- 积分查询和操作的详细日志改为DEBUG级别
- 只在 `ENABLE_DEBUG_LOGS=true` 时输出

### 3. 语音服务 (VoiceService)
- 语音合成的详细过程日志改为DEBUG级别
- 只保留错误和警告日志

### 4. Dify服务 (DifyService)
- API请求详情改为DEBUG级别
- 工作流响应详情改为DEBUG级别

### 5. HTTP请求日志
- httpx、requests等第三方库的日志级别提升到WARNING
- 只在 `ENABLE_HTTP_LOGS=true` 时显示详细HTTP日志

## 使用方法

### 1. 更新环境变量

在你的 `.env` 文件中添加：

```bash
# 生产环境推荐
LOG_LEVEL=WARNING
ENABLE_DEBUG_LOGS=false
ENABLE_RLS_DEBUG=false
ENABLE_HTTP_LOGS=false
LOG_SQL_QUERIES=false
```

### 2. 重启应用

```bash
# 重启API服务
python -m uvicorn app.main:app --reload

# 或重启Docker容器
docker-compose restart api
```

### 3. 验证效果

重启后，你应该看到：
- 日志数量显著减少
- 只显示WARNING和ERROR级别的重要信息
- 用户报错更容易发现和追踪

## 临时调试

如果需要临时开启某个调试功能，可以：

```bash
# 临时开启RLS调试
export ENABLE_RLS_DEBUG=true

# 重启服务后生效
```

## 日志级别说明

- **ERROR**: 严重错误，需要立即关注
- **WARNING**: 警告信息，可能需要关注
- **INFO**: 一般信息，正常操作记录
- **DEBUG**: 详细调试信息，仅开发使用

## 推荐实践

1. **生产环境**: 使用WARNING级别，关闭所有调试开关
2. **测试环境**: 使用INFO级别，根据需要开启调试开关
3. **开发环境**: 使用DEBUG级别，开启需要的调试功能
4. **问题排查**: 临时开启相关的调试开关，排查完毕后关闭

这样可以确保生产环境的日志干净整洁，同时保留了调试的灵活性。