# Alembic 数据库迁移使用指南

本项目使用 Alembic 来管理数据库结构的变更。请遵循以下工作流程来修改数据库表。

## 核心理念

**不要直接在 Supabase UI 中手动修改表结构！** 所有的变更都应该通过创建和运行迁移脚本来完成，以保证开发、测试和生产环境的一致性。

## 工作流程

### 1. 创建一个新的迁移脚本

当你需要修改数据库时（例如，添加一个表、增加一个字段），首先运行以下命令来生成一个新的迁移文件。

**请在 `api/` 目录下运行此命令。**

```bash
alembic revision -m "你的变更描述"
```

**示例:**
```bash
alembic revision -m "add_bio_to_user_profiles"
```

这个命令会在 `alembic/versions/` 目录下创建一个新的 Python 文件。

### 2. 编写迁移脚本

打开新生成的迁移文件。你会看到 `upgrade()` 和 `downgrade()` 两个函数。

*   `upgrade()`: 在这里编写你的数据库变更逻辑。
*   `downgrade()`: 在这里编写撤销变更的逻辑，以便能够回滚。

你可以使用 Alembic 的 `op` 对象来执行操作，或者直接执行原生 SQL。

**示例：使用原生 SQL 添加一个 `bio` 字段**

```python
# In alembic/versions/xxxx_add_bio_to_user_profiles.py

from alembic import op
import sqlalchemy as sa

# revision identifiers, used by Alembic.
revision = 'xxxx' # 会自动生成
down_revision = 'yyyy' # 会自动生成
branch_labels = None
depends_on = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.execute("""
    ALTER TABLE public.user_profiles
    ADD COLUMN bio TEXT;
    """)
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.execute("""
    ALTER TABLE public.user_profiles
    DROP COLUMN bio;
    """)
    # ### end Alembic commands ###

```

### 3. 应用迁移到数据库

编写完脚本后，运行以下命令将变更应用到你的 Supabase 数据库。

```bash
alembic upgrade head
```

`head` 指的是最新的迁移版本。

### 4. （可选）回滚迁移

如果发现有问题，你可以回滚到上一个版本。

```bash
# 回滚一个版本
alembic downgrade -1

# 回滚到指定的版本号
alembic downgrade <revision_id>
```

### 5. 查看迁移历史

你可以使用以下命令来查看当前的迁移状态和历史记录。

```bash
# 查看所有迁移及其状态
alembic history --verbose

# 显示当前的数据库版本
alembic current
```
